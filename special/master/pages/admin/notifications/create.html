---
### ALL PAGES ###
layout: master/admin/main
permalink: /admin/notifications/
sitemap:
  include: false

### REGULAR PAGES ###
meta:
  title: "Notifications"
  description: "Send push notifications to capture your audience!"
  breadcrumb: "Notifications"
---
<!-- Header -->
<div class="header mt-md-5">
  <div class="header-body">
    <div class="row align-items-center">
      <div class="col">

        <!-- Pretitle -->
        <h6 class="header-pretitle">
          Notifications
        </h6>

        <!-- Title -->
        <h1 class="header-title">
          New
        </h1>

        <p class="text-muted mb-0">Send push notifications to capture your audience!</p>
      </div>
    </div> <!-- / .row -->
  </div>
</div>

<div class="row loaded-false">
  <div class="col-lg-8 offset-lg-2">
    <div class="d-flex justify-content-center">
      <div class="spinner-border text-primary" role="status">
        
      </div>
    </div>
  </div>
</div>

<!-- Form -->
<div class="loaded-true" hidden>
  <form class="mb-4" onsubmit="return false;" id="notification-form">

    <h2 class="header-title my-3">
      Notification details
    </h2>

    <div class="row">

      <div class="col-12">
        <div class="form-group">
          <label>
            Title
          </label>
          <small class="form-text text-muted">
            The title of the notification
          </small>
          <div class="input-group input-group-merge mb-3">
            <input type="text" class="form-control form-control-appended" id="title" name="title">
            <div class="input-group-append">
              <span class="input-group-text">
                0
              </span>
            </div>
          </div>
        </div>
      </div>

      <div class="col-12">
        <div class="row">
          <div class="col-10">
            <div class="form-group">
              <label>
                Icon URL
              </label>
              <small class="form-text text-muted">
                The icon of the notification
              </small>
              <div class="input-group input-group-merge mb-3">
                <input type="text" class="form-control" id="icon" name="icon">
                </div>
            </div>
          </div>
          <div class="col-2">
            <!-- <img class="img-fluid img-thumbnail" id="preview-icon" src="" alt="" style="min-width: 12vh; min-height: 12vh;"> -->
            <img class="img-fluid img-thumbnail" id="preview-icon" src="" alt="" style="">
          </div>
        </div>
      </div>

      <div class="col-12">
        <div class="form-group">
          <label>
            Click action
          </label>
          <small class="form-text text-muted">
            The URL to go to when clicked
          </small>
          <div class="input-group input-group-merge mb-3">
            <input type="text" class="form-control" id="click_action" name="click_action">

          </div>
        </div>
      </div>

      <div class="col-12">
        <div class="form-group">
          <label>
            Body
          </label>
          <small class="form-text text-muted">
            The body of the notification
          </small>
          <div class="input-group input-group-merge mb-3">
            <textarea class="form-control form-control-appended" id="body" name="body"rows="2"></textarea>
            <div class="input-group-append">
              <span class="input-group-text">
                0
              </span>
            </div>
          </div>
        </div>
      </div>

      <div class="col-12">
        <div class="form-group">
          <label>
            Processing Address
          </label>
          <small class="form-text text-muted">
            What address to process the post at? (Local or Production)
          </small>
          <div class="input-group input-group-merge mb-3">
            <select class="custom-select" id="processingAddy" name="processingAddy" required>
              <option id="processingAddy_none" value="">Select an address</option>
              <option id="processingAddy_dev" value="">Development</option>
              <option id="processingAddy_prod" value="">Production</option>
            </select>
          </div>
        </div>
      </div>

  </div>

  <hr class="mt-4 mb-5">

  <div class="row">

    <!-- Divider -->

    <div class="col-12">

      <div id="response" hidden>
        <div class="my-3">
          <div class="alert alert-info" role="alert" hidden>
            <h4 class="alert-heading">Waiting...</h4>
            <p class="mb-0">Hold up</p>
            <!-- <hr>
            <p class="mb-0">Be sure to check it out on the main blog page (<a href="{{ site.url }}/blog/">{{ site.url }}/blog/</a>) to see if it looks good!</p>
            <p class="mb-0">Refreshing in <span id="refresh-timer">3</span> seconds.</p> -->
          </div>
          <div class="alert alert-success" role="alert" hidden>
            <h4 class="alert-heading">Well done!</h4>
            <p>Aww yeah, you successfully sent that awesome notification and <strong>tons</strong> of people will see your message.;)</p>
            <hr>
            <p class="mb-0"></p>
          </div>
          <div class="alert alert-danger" role="alert" hidden>
            <h4 class="alert-heading">Aw snap!</h4>
            <p class="mb-0">Something went wrong, please examine the error below:</p>
            <hr>
            <pre><code id="main-response-code" class="text-white">waiting...
            </code></pre>
          </div>
        </div>
      </div>
    </div>

    <div class="col-12">
      <button class="btn btn-primary btn-lg w-100" id="post-submit-btn" type="submit">Send!</button>
    </div>
  </div>
</form>
</div>


<script src="https://code.jquery.com/jquery-3.4.1.slim.min.js" integrity="sha384-J6qa4849blE2+poT4WnyKhv5vZF5SrPo0iEjwBvKU7imGFAV0wwj1yYfoRSJoZ+n" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js" integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo" crossorigin="anonymous"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js" integrity="sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6" crossorigin="anonymous"></script>


<script type="text/javascript">
  // fields
  var fields = {};
  {% for post in site.posts limit:1 %}
  fields = {
    title: "{{ site.brand.name }}",
    click_action: "{{ site.url }}",
    body: "",
    icon: "{{ site.brand.logo-image }}"
  }
  {% endfor %}


  // console.log('FIELDS', fields);

</script>

<!-- Exploring the library -->
<script type="text/javascript">

  var navBlocked = false;
  var allowLeave = true;
  var stackEditElement = document.querySelector('#body');
  var stackedit;
  var turndownService;
  var dom;
  var lastPreviewIcon = '';

  var buildFile = {};

  Manager.ready(function() {
    fetch('{{ site.url }}/@output/build/build.json', {
      method: 'GET',
    })
    .then(function (res) {
      if (res.status >= 200 && res.status < 300) {
        res.json()
        .then(function (data) {
          console.log('Success', data);
          buildFile = data;
          dom = Manager.dom();
          blockNavigation();
          setupForm();
          countChars();
          getPreviewIcon();
          dom.select('body').on('click', function(event) {
            if (event.target.matches('#stackedit-edit')) {
            }
          });

          dom.select('body').on('keyup', function (event) {
            countChars();
            getPreviewIcon();
            allowLeave = false;
          });

          function getPreviewIcon() {
            var newPreviewIcon = dom.select('#icon').getValue();
            if (lastPreviewIcon != newPreviewIcon) {
              // console.log('NEW', newPreviewIcon);
              lastPreviewIcon = newPreviewIcon;
              dom.select('#preview-icon').setAttribute('src', newPreviewIcon);
            }
          }

          function setupForm() {
            dom.select('#title').setValue(fields.title);
            // dom.select('#click_action').setValue(fields.click_action.replace(/\/(.*?)\//,'').replace(/\//,''));
            dom.select('#click_action').setValue(fields.click_action);
            dom.select('#icon').setValue(fields.icon);
            dom.select('#body').setValue("");

            // special
            var serverDev = 'http://localhost:5001/' + Manager.properties.options.libraries.firebase_app.config.projectId + '/us-central1/bm_sendNotification';
            var serverProd = 'https://us-central1-' + Manager.properties.options.libraries.firebase_app.config.projectId + '.cloudfunctions.net/bm_sendNotification';
            var env = buildFile.environment;
            dom.select('#processingAddy_dev').setInnerHTML(serverDev).setAttribute('value', serverDev);
            dom.select('#processingAddy_prod').setInnerHTML(serverProd).setAttribute('value', serverProd);
            dom.select('#processingAddy').setValue(env == 'development' ? serverDev : serverProd);

          }

          dom.select('#notification-form').on('submit', function (event) {
            blockNavigation();
            displayWaiting();
            // var endpoint = '{{ site.url }}/admin/post/create.json';
            var endpoint = dom.select('#processingAddy').getValue();
            // endpoint = 'http://localhost:5001/ultimate-jekyll/us-central1/bm_createPost';

            var token = '';
            firebase.auth().currentUser.getIdToken(true)
            .then(function(token) {
              token = token;

              var data = {};
              var finalData = {};
              dom.select('#notification-form input, #notification-form select, #notification-form textarea').each(function (el, i) {
                var curField = dom.select(el);
                data[curField.getAttribute('name')] = curField.getValue();
              });
              finalData.authenticationToken = token;
              finalData.payload = {};
              finalData.payload.title = data.title;
              finalData.payload.icon = data.icon;
              finalData.payload.click_action = data.click_action;
              finalData.payload.body = data.body;

              console.log('#notification-form', endpoint, finalData);


              fetch(endpoint, {
                method: 'POST',
                body: JSON.stringify(finalData),
              })
              .then(function (res) {
                if (res.status >= 200 && res.status < 300) {
                  res.json()
                  .then(function (data) {
                    console.log('Success', data);
                    displayError();

                    allowLeave = true;
                  })
                } else {
                  return res.text()
                  .then(function (data) {
                    throw new Error(data || res.statusText || 'Unknown error.')
                  })
                }
              })
              .catch(function (e) {
                console.error(e);
                displayError(e);
              })

            })
            .catch(function(e) {
              display('Failed to get firebase token: ' + e);
            })
          });

          function displayWaiting() {
            dom.select('#response .alert-danger').hide()
            dom.select('#response .alert-success').hide()

            dom.select('#response .alert-info').show()
            dom.select('#response').show()
            dom.select('#post-submit-btn').setAttribute('disabled', true);
          }

          function displayError(error) {
            dom.select('#response .alert-info').hide()
            dom.select('#post-submit-btn').removeAttribute('disabled');
            if (error) {
              dom.select('#response').show()
              dom.select('#response .alert-success').hide()
              dom.select('#response .alert-danger').show()
              dom.select('#main-response-code').setInnerHTML(error)
            } else {
              dom.select('#response').show()
              dom.select('#response .alert-success').show()
              dom.select('#response .alert-danger').hide()
            }
          }

          dom.select('.loaded-false').hide();
          dom.select('.loaded-true').show();
        })
      } else {
        return res.text()
        .then(function (data) {
          throw new Error(data || res.statusText || 'Unknown error.')
        })
      }

    })
    .catch(function (e) {
      console.error(e);
    })

  });

  function countChars() {
    var charCountFields = ['title', 'body'];
    for (var i = 0; i < charCountFields.length; i++) {
      var cur = dom.select('*[name="' + charCountFields[i] + '"]').get(0);
      dom.select(cur.parentNode.childNodes).each(function (element, i) {
        if (element.matches('.input-group-append')) {
          dom.select(element.querySelectorAll('.input-group-append .input-group-text')).setInnerHTML(dom.select(cur).getValue().length);
        }
      })
    }
  }

  function blockNavigation() {
    if (navBlocked === true) {
      return;
    }
    navBlocked = true;
    try {
      window.onbeforeunload = function(event) {
        if (allowLeave) {
          event.preventDefault();
        } else {
          event.returnValue = "Write something clever here..";
        }
      };
    } catch (e) {
      console.error('Error creating post', e);
    }
  }



</script>
