---
### ALL PAGES ###
layout: master/reference/main
permalink: /@reference/examples/auth-and-notifications/
sitemap:
  include: false
settings:
  manager-configuration: "
    {
      pushNotifications: {
        autoRequest: false
      }
    }
  "
---
<div class="form-signin text-center">
  <form class="auth-signin-form auth-signup-form" onsubmit="return false;">
    <h1 class="h3 mb-3 font-weight-normal">.auth() Library</h1>

    <div class="auth-signedin-false-element" hidden>
      <div class="mb-3">
        Not signed in
      </div>


      <div class="accordion card" id="accordionExample">
        <div class="card">
          <div class="card-header" id="headingOne">
            <h2 class="mb-0">
              <button class="btn btn-link" type="button" data-toggle="collapse" data-target="#auth-providers-panel" aria-expanded="true" aria-controls="auth-providers-panel">
                Sign in / Sign up using third-party providers
              </button>
            </h2>
          </div>

          <div id="auth-providers-panel" class="collapse" aria-labelledby="headingOne" data-parent="#accordionExample">
            <div class="card-body">
              <div class="row">
                <div class="col-12 mb-1">
                  <a class="btn btn-sm btn-light transition-3d-hover btn-block auth-signin-provider-btn" data-provider="google.com">
                    <img src="https://cdn.itwcreativeworks.com/assets/general/images/brands/color/google.svg" class="lazyload" alt="Google Logo" width="24em">
                    Sign in with Google
                  </a>
                </div>
                <div class="col-12 mb-1">
                  <a class="btn btn-sm btn-light transition-3d-hover btn-block auth-signin-provider-btn" data-provider="facebook.com">
                    <img src="https://cdn.itwcreativeworks.com/assets/general/images/brands/color/facebook.svg" class="lazyload" alt="Facebook Logo" width="24em">
                    Sign in with Facebook
                  </a>
                </div>
                <div class="col-12 mb-1">
                  <a class="btn btn-sm btn-light transition-3d-hover btn-block auth-signin-provider-btn" data-provider="twitter.com">
                    <img src="https://cdn.itwcreativeworks.com/assets/general/images/brands/color/twitter.svg" class="lazyload" alt="Twitter Logo" width="24em">
                    Sign in with Twitter
                  </a>
                </div>
                <div class="col-12 mb-1">
                  <a class="btn btn-sm btn-light transition-3d-hover btn-block auth-signin-provider-btn" data-provider="github.com">
                    <img src="https://cdn.itwcreativeworks.com/assets/general/images/brands/color/github.svg" class="lazyload" alt="GitHub Logo" width="24em">
                    Sign in with GitHub
                  </a>
                </div>
                <div class="col-12 mb-1">
                  <a class="btn btn-sm btn-light transition-3d-hover btn-block auth-signin-provider-btn" data-provider="microsoft.com">
                    <img src="https://cdn.itwcreativeworks.com/assets/general/images/brands/color/microsoft.svg" class="lazyload" alt="Microsoft Logo" width="24em">
                    Sign in with Microsoft
                  </a>
                </div>
                <div class="col-12 mb-1">
                  <a class="btn btn-sm btn-light transition-3d-hover btn-block auth-signin-provider-btn" data-provider="yahoo.com">
                    <img src="https://cdn.itwcreativeworks.com/assets/general/images/brands/color/yahoo-y.svg" class="lazyload" alt="Yahoo Logo" width="24em">
                    Sign in with Yahoo
                  </a>
                </div>
                <div class="col-12 mb-1">
                  <a class="btn btn-sm btn-light transition-3d-hover btn-block auth-signin-provider-btn" data-provider="apple.com">
                    <img src="https://cdn.itwcreativeworks.com/assets/general/images/brands/color/apple.svg" class="lazyload" alt="Apple Logo" width="24em">
                    Sign in with Apple
                  </a>
                </div>
                <div class="col-12">
                  <a class="btn btn-sm btn-light transition-3d-hover btn-block auth-signin-provider-btn" data-provider="noexist.com">
                    Sign in with a non-existant service
                  </a>
                </div>
              </div>
            </div>
          </div>
        </div>

      </div>





      <div class="my-3 text-center text-muted">
        <small>— or —</small>
      </div>

      <div class="form-group">
        <label for="email-input" class="sr-only">Email</label>
        <input type="email" id="email-input" class="form-control auth-email-input" placeholder="Email" required autofocus autocomplete="email">
      </div>

      <div class="form-group">
        <label for="password-input" class="sr-only">Password</label>
        <input type="password" id="password-input" class="form-control auth-password-input" placeholder="Password" required autofocus autocomplete="current-password">
      </div>

      <div class="form-group">
        <label for="password-confirm-input" class="sr-only">Password Confirm</label>
        <input type="password" id="password-confirm-input" class="form-control auth-password-confirm-input" placeholder="Password confirm" required autofocus autocomplete="new-password">
      </div>

      <div class="form-check">
        <input type="checkbox" class="form-check-input auth-terms-input" id="auth-terms-input" required>
        <label class="form-check-label" for="auth-terms-input">I agree to the Terms and Conditions</label>
      </div>
      <div class="form-check">
        <input type="checkbox" class="form-check-input auth-newsletter-input" id="auth-newsletter-input">
        <label class="form-check-label" for="auth-newsletter-input">Sign up for our newsletter</label>
      </div>

      <div class="alert alert-danger auth-error-message-element" hidden>
      </div>

      <button class="btn btn-lg btn-primary btn-block auth-signin-email-btn" type="submit" name="button">Sign in</button>
      <button class="btn btn-lg btn-primary btn-block auth-signup-email-btn" type="submit" name="button">Sign up</button>
      <button class="btn btn-lg btn-primary btn-block auth-forgot-email-btn" type="submit" name="button">Forgot</button>
    </div>

    <div class="auth-signedin-true-element" hidden>
      <div class="">
        Signed in
      </div>

      <div class="card mb-3" style="">
        <div class="card-body">
          <div class="mb-3">
            Email: <span class="auth-email-element">...</span> <br>
            UserId: <span class="auth-uid-element">...</span> <br>
            <div class="text-left">
              <pre id="resolve-account-result">Click "Resolve Account" to get Firebase account data</pre>
            </div>
          </div>
          <button id="resolve-account" class="btn btn-lg btn-primary btn-block">Resolve Account</button>
          <button class="btn btn-lg btn-primary btn-block auth-signout-all-btn" type="button" name="button">Sign out</button>
        </div>
      </div>

    </div>
  </form>

  <form class="" onsubmit="return false;">
    <div class="">
      <h1 class="h3 my-3 font-weight-normal">.notifications() Library</h1>
      <h5 class="my-3">Subscribing</h5>
      <button class="btn btn-lg btn-primary btn-block" id="subscribe-check" type="button" name="button">.isSubscribed()</button>

      <button class="btn btn-lg btn-primary btn-block" id="subscribe-real" type="button" name="button">.subscribe()</button>
      <button class="btn btn-lg btn-primary btn-block" id="subscribe-fake" type="button" name="button">Subscribe fake</button>
      <h5 class="my-3">Sending</h5>
      <div class="form-group">
        <label for="notification-address" class="sr-only">Address</label>
        <input type="url" id="notification-address" class="form-control" placeholder="">
      </div>
      <button class="btn btn-lg btn-primary btn-block" id="send" type="button" name="button">Send</button>

      <div class="card my-3" style="">
        <div class="card-body">
          <pre id="result" class="text-left">
            waiting...
          </pre>
        </div>
      </div>

    </div>
  </form>

</div>

<!-- Exploring the library -->
<script type="text/javascript">
  Manager.ready(function() {

    // Inner event listener
    Manager.auth().ready(function() {
      console.log('.auth().ready()');
      console.log('.isAuthenticated():', Manager.auth().isAuthenticated());
      console.log('.getUser(): ', Manager.auth().getUser());
      firebase.auth().onAuthStateChanged(function(user) {
        console.log('.onAuthStateChanged():', user);
      })

      if (Manager.properties.meta.environment === 'development') {
        Manager.dom().select('#notification-address').setValue('http://localhost:5001/' + Manager.properties.options.libraries.firebase_app.config.projectId + '/us-central1/bm_api');
      } else {
        Manager.dom().select('#notification-address').setValue('https://us-central1-' + Manager.properties.options.libraries.firebase_app.config.projectId + '.cloudfunctions.net/bm_api');
      }
    });

    function display(message) {
      Manager.log(message);
      Manager.dom().select('#result').setInnerHTML(message);
    }

    Manager.dom().select('body').on('click', function(event) {
      if (event.target.matches('#subscribe-fake')) {
        var tempID = Math.floor(Math.random() * 10000) + 1;
        firebase.firestore().doc('notifications/subscriptions/all/' + tempID)
          .set(
          {
            meta: {
              dateSubscribed: {
                timestamp: '',
                timestampUNIX: new Date().getTime(),
              },
            },
            token: tempID.toString(),
            linked: {
              user: {
                timestampLastLinked: '',
                data: {
                  meta: {
                    uid: ''
                  }
                }
              }
            },
            tags: ['general']
          }
          )
          .then(function(data) {
            display('Successfully set fake subscription!', data)
          })
          .catch(function(e) {
            display('Failed to set Firestore doc: ' + JSON.stringify(e, undefined, 2))
          });
      } else if (event.target.matches('#subscribe-real')) {
        Manager.notifications().subscribe()
          .then(function(response) {
            display('Success. Was subscribe performed? = ' + JSON.stringify(response, undefined, 2))
          })
          .catch(function(e) {
            display('Failed to subscribe: ' + JSON.stringify(e, undefined, 2))
          })

        } else if (event.target.matches('#subscribe-check')) {
          // Manager.notifications().checkSubscription()
          //   .then(function(response) {
          //     Manager.dom().select('#result').setInnerHTML('Subscription status = ' + JSON.stringify(response, undefined, 2))
          //   })
          //   .catch(function(e) {
          //     Manager.dom().select('#result').setInnerHTML('Failed to check subscription status: ' + JSON.stringify(e, undefined, 2))
          //   })
          Manager.notifications().isSubscribed()
            .then(function(response) {
              display('isSubscribed = ' + JSON.stringify(response, undefined, 2))
            })
            .catch(function(e) {
              display('Failed to check subscription status: ' + JSON.stringify(e, undefined, 2))
            })

        } else if (event.target.matches('#send')) {
          if (!firebase.auth().currentUser) {
            return Manager.dom().select('#result').setInnerHTML('There is no active user.'); // Set setInnerHTML
          }
          firebase.auth().currentUser.getIdToken(true)
          .then(function(token) {
            fetch(Manager.dom().select('#notification-address').getValue(), {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                authenticationToken: token,
                command: 'admin:send-notification',
                payload: {
                  icon: '{{ site.brand.logo-image }}',
                  click_action: '{{ site.url }}',
                  title: 'Test title',
                  body: 'Test body'
                }
              }),
            })
            .then(function (res) { // This function runs only on success
              if (res.status >= 200 && res.status < 300) {
                res.json()
                .then(function (data) {
                  console.log('Success', data);
                  Manager.dom().select('#result').setInnerHTML(JSON.stringify(data, undefined, 2)); // Set setInnerHTML
                })
              } else {
                return res.text()
                .then(function (data) {
                  throw new Error(data || res.statusText || 'Unknown error.')
                })
              }
            })
            .catch(function (e) { // This function runs only on error
              console.log('Fail', e);
              Manager.dom().select('#result').setInnerHTML(e); // Set setInnerHTML
            })
            .finally(function () { // This function runs regardless of a success or error
              console.log('Always');
            });

          })

        } else if (event.target.matches('#resolve-account')) {
          console.log('--- Exploring the .account() API ---');
          var user = firebase.auth().currentUser;
          var accountResultEl = Manager.dom().select('#resolve-account-result');
          accountResultEl.setInnerHTML('Waiting...');

          if (!user) {
            accountResultEl.setInnerHTML('No user :(');
          } else {
            firebase.firestore().doc('users/' + user.uid)
            .get()
            .then(function (doc) {
              Manager.account().import()
              .then(function (Account) {
                var account = new Account();
                account.resolve(doc.data(), {})
                .then(function (properties) {
                  console.log('.account().resolve()', properties);
                  accountResultEl.setInnerHTML(JSON.stringify(properties, null, 2));
                })
              })
              .catch(function (e) {
                accountResultEl.setInnerHTML(e);
              })
            })
            .catch(function (e) {
              accountResultEl.setInnerHTML(e);
            })
          }
        }

    })
  });

</script>
