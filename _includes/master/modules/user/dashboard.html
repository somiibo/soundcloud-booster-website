<script src="https://cdn.jsdelivr.net/npm/wonderful-fetch@latest/dist/index.min.js?cb={{ site.time | date: "%s" }}"></script>
<script src="https://cdn.jsdelivr.net/npm/node-powertools@latest/dist/index.min.js?cb={{ site.time | date: "%s" }}"></script>

<!-- Default elements -->
<div id="dashboard-template-display-error" data-template='
  <div class="toast-container position-fixed p-3 top-0 start-50 translate-middle-x" style="z-index: 1003; _min-width: 50vw;">
    <div class="dashboard-display-error toast bg-danger text-white">
      <div class="d-flex">
        <div class="toast-body">
          <h4 class="text-white">Error</h4>
          <span class="dashboard-display-error-message">
            Unknown error
          </span>
        </div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
      </div>
    </div>
  </div>
'>
</div>

<div id="dashboard-template-unsaved-popup" data-template='
  <div class="dashboard-display-unsaved-popup" hidden>
    <div class="position-fixed start-50 bottom-0 translate-middle-x w-100 zi-99 mb-3" style="max-width: 40rem;" >
      <div class="card card-sm bg-dark border-dark mx-2">
        <div class="card-body">
          <div class="row justify-content-center justify-content-sm-between">
            <div class="col d-flex align-items-center text-white">
              You have unsaved changes!
            </div>

            <div class="col-auto">
              <div class="d-flex gap-3">
                <button type="submit" class="btn btn-primary">
                  <span class="dashboard-display-loader" hidden>
                    <div class="spinner-border spinner-border-sm text-light" role="status"></div>
                  </span>
                  Save
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
'>
</div>

<script type="text/javascript">
  var DashboardManager = {

  }
  var inputAndSubmit = 'input, textarea, select, button[type="submit"]';
  var select;
  var get;
  var set;
  var storage;

  window.onbeforeunload = function (event) {
    var result = undefined;

    Object.keys(DashboardManager).forEach(function (id) {
      var dashboard = DashboardManager[id];

      if (!dashboard.allowLeave) {
        result = '';
      }
    });

    return result;
  }

  function Dashboard() {
    var self = this;

    self.id = null;
    self.element = {};
    self.options = {};
    self.allowLeave = true;

    self._handler = {
      onSubmit: function () {},
      onChange: function () {},
      transformData: function (data) {return data},
    }
    self._triggeredInitialOnChangeEvent = false;
    self._$manualChangeTriggerElement = null;

    // Set global libraries
    select = Manager.dom().select;
    get = Manager.utilities().get;
    set = Manager.utilities().set;
    storage = Manager.storage();


    return self;
  }

  Dashboard.prototype.register = function (id, options) {
    var self = this;

    self.id = id;

    // Set default options
    options = options || {};

    options.error = options.error || {};
    options.error.parent = options.error.parent || '.dashboard-display-error';
    options.error.message = options.error.message || '.dashboard-display-error-message';

    options.unsaved = options.unsaved || {};
    options.unsaved.parent = options.unsaved.parent || '.dashboard-display-unsaved-popup';

    options.loader = options.loader || {};
    options.loader.parent = options.loader.parent || '.dashboard-display-loader';

    options.createDefaultElements = typeof options.createDefaultElements === 'undefined' ? true : options.createDefaultElements;
    options.showUnsavedPopup = typeof options.showUnsavedPopup === 'undefined' ? true : options.showUnsavedPopup;

    self.element.id = select(id);

    // Create default elements
    if (options.createDefaultElements) {
      self.element.id.get(0).insertAdjacentHTML('beforeend', document.getElementById('dashboard-template-display-error').getAttribute('data-template'));
      self.element.id.get(0).insertAdjacentHTML('beforeend', document.getElementById('dashboard-template-unsaved-popup').getAttribute('data-template'));
    }

    // Setup the reset of the elements
    self.element.error = {
      parent: select(options.error.parent),
      message: select(options.error.message),
    };

    self.element.unsaved = {
      parent: select(options.unsaved.parent),
    };

    self.element.loader = {
      parent: select(options.loader.parent),
    };

    DashboardManager[self.id] = {
      allowLeave: self.allowLeave,
    };

    // Change handler
    var events = ['change', 'keydown'];
    var elements = ['input', 'textarea', 'select'];
    var $form = self.element.id.get(0);

    function _changeHandler(event) {
      setTimeout(function () {
        if (event.key === 'Enter') {
          return
        }

        console.log('[Dashboard]', id, 'change event', event);

        if (options.showUnsavedPopup) {
          self.element.unsaved.parent.removeAttribute('hidden');
        }

        self.setAllowLeave(false);

        self.display('ready');

        self._handler.onChange(event, self.getFormData());
      }, 1);
    }

    elements.forEach(function (event) {
      $form.querySelectorAll(event)
      .forEach(function ($el) {
        self._$manualChangeTriggerElement = $el;

        events.forEach(function (event) {
          $el.addEventListener(event, function (event) {
            _changeHandler(event);
          });
        });
      });
    })

    self.element.id.get(0).addEventListener('submit', function (event) {
      console.log('[Dashboard]', id, 'submit event', event);

      self.display('loading');

      self._handler.onSubmit(event, self.getFormData());
    });

    // Set templates
    options.template = options.template || {};
    select('.dashboard-template').each(function ($el) {
      var id = $el.getAttribute('data-template-id');
      var body = $el.getAttribute('data-template-body');

      if (id && body) {
        options.template[id] = body;
      }
    })

    // self.display('loading');
    self.display('initializing');

    self.options = options;

    // Trigger initial event manually
    if (!self._triggeredInitialOnChangeEvent) {
      if (self._$manualChangeTriggerElement) {
        self.triggerOnChange();
      }

      self._triggeredInitialOnChangeEvent = true;
    }

    return self;
  };

  Dashboard.prototype.triggerOnChange = function ($el) {
    var self = this;
    var $usableElement = $el || self._$manualChangeTriggerElement;

    $usableElement.dispatchEvent(new Event('change'));
  }


  Dashboard.prototype.setAllowLeave = function (state) {
    var self = this;

    self.allowLeave = state;

    DashboardManager[self.id].allowLeave = state;

    return self;
  }

  Dashboard.prototype.display = function (status) {
    var self = this;

    var _error;

    // status: initializing | ready | loading | success | error
    if (status instanceof Error) {
      _error = status;
      status = 'error';
    }
    var state = status === 'initializing' ? 'initializing' : 'initialized';
    var elements = self.element.id.get(0).querySelectorAll(inputAndSubmit);

    console.log('[Dashboard] display', self.id, 'status', status, 'state', state);

    // Enable or disable all inputs and submit buttons
    elements
    .forEach(function (el) {
      var $el = select(el);

      if (
        ['initializing', 'loading'].includes(status)
        && (!el.classList.contains('disabled') || !el.hasAttribute('disabled'))
      ) {
        $el.addClass('disabled').setAttribute('disabled', true);
      } else if (
        el.classList.contains('disabled')
        || el.hasAttribute('disabled')
      ) {
        $el.removeClass('disabled').removeAttribute('disabled');
      }
    });

    // Set dynamic state
    select('.dashboard-state-listener').setAttribute('hidden', true);
    select('.dashboard-state-listener[data-state="' + state + '"]').removeAttribute('hidden');

    // Show spinner or hide
    if (['initializing', 'loading'].includes(status)) {
      self.element.loader.parent.removeAttribute('hidden');
    } else {
      self.element.loader.parent.setAttribute('hidden', true);
    }

    // Remove unsaved changes popup
    if (['success', 'error'].includes(status)) {
      self.element.unsaved.parent.setAttribute('hidden', true);
    }

    // Show error message
    var toasts = [];

    try {
      self.element.error.parent
      .each(function (el) {
        toasts.push(new bootstrap.Toast(el, {}))
      })
    } catch (e) {

    }

    // Show error message
    if (status === 'error') {
      if (toasts.length > 0) {
        toasts
        .forEach(function (toast) {
          toast.show();
          toast._element.querySelector('.dashboard-display-error-message').innerHTML = _error.message;
        });
      } else {
        self.element.error.parent.removeAttribute('hidden');
        self.element.error.parent.querySelector('.dashboard-display-error-message').innerHTML = _error.message;
      }
    } else {
      if (toasts.length > 0) {
        toasts
        .forEach(function (toast) {
          toast.hide();
        });
      } else {
        self.element.error.parent.setAttribute('hidden', true);
      }
    }

    // Set allow leave
    if (['success'].includes(status)) {
      self.setAllowLeave(true);
    }

    return self;
  };

  Dashboard.prototype.getFormData = function () {
    var self = this;
    var data = {};
    var $form = self.element.id.get(0);

    $form.querySelectorAll(inputAndSubmit)
    .forEach(function (el) {
      var $el = select(el);
      var name = $el.getAttribute('name');
      var value = select('#' + $form.id + ' [name="' + name + '"]').getValue();

      set(data, name, value);
    });

    return self._handler.transformData(data);
  };

  Dashboard.prototype.transformData = function (fn) {
    var self = this;

    self._handler.transformData = fn;

    return self;
  };

  Dashboard.prototype.onSubmit = function (fn) {
    var self = this;

    self._handler.onSubmit = fn;

    return self;
  };

  Dashboard.prototype.onChange = function (fn) {
    var self = this;

    self._handler.onChange = fn;

    return self;
  };

  window.Dashboard = Dashboard;

  // Log
  console.log('Dashboard loaded', Dashboard);
</script>


<!--
  Make a dashboard suite
  - include an error toast
  - a success toast
  - a popup toast to save changes
  - ability to set a allowLeave whihc will prevent navigation
 -->
