(self.webpackChunkultimate_jekyll=self.webpackChunkultimate_jekyll||[]).push([[2940,6002],{634:()=>{},938:()=>{},2480:()=>{},3005:()=>{},4050:()=>{},5043:()=>{},6600:()=>{},7664:()=>{},8466:()=>{},9087:(e,t,n)=>{"use strict";n.r(t),n.d(t,{default:()=>s});var o=n(2984),i=n(4289),c=n.n(i);const a=async function(e,t={}){window.Manager;const o=JSON.parse(JSON.stringify(t)),{getAuth:i}=await Promise.all([n.e(9943),n.e(5708)]).then(n.bind(n,5708)),a=i().currentUser;if(!a)throw new Error("No authenticated user found");const r=await a.getIdToken();return o.headers||(o.headers={}),o.headers.Authorization="Bearer "+r,c()(e,o)};let r=null;const s=e=>new Promise(async function(t){r=e.webManager,await r.dom().ready();try{await async function(){f||(f=!0,l=new o.A("#notification-form",{autoDisable:!0,showSpinner:!0,validateOnSubmit:!0,allowMultipleSubmissions:!1}),l.addEventListener("change",m),l.addEventListener("submit",h),function(){const e=document.querySelector('input[name="notification.icon"]');e&&e.addEventListener("input",e=>{!function(e){const t=document.querySelector("#preview-icon");t&&(e&&e.match(/^https?:\/\/.+/)?(t.src=e,t.onerror=()=>{t.src="https://via.placeholder.com/50"}):t.src="https://via.placeholder.com/50")}(e.target.value)});const t=document.querySelector('input[name="notification.title"]');t&&(r.isDevelopment()&&(t.value="Test Notification Title"),t.addEventListener("input",e=>{const t=e.target.value.length,n=document.querySelector("#title-char-count");n&&(n.textContent=`${t} / 60`,n.className=t>60?"text-danger":"text-muted")}));const n=document.querySelector('textarea[name="notification.body"]');n&&(r.isDevelopment()&&(n.value="This is a test notification body message for development."),n.addEventListener("input",e=>{const t=e.target.value.length,n=document.querySelector("#body-char-count");n&&(n.textContent=`${t} / 200`,n.className=t>200?"text-danger":"text-muted")}));const o=document.querySelector(".btn-set-auto-submit");o&&o.addEventListener("click",()=>{!function(){const e=new Date;e.setDate(e.getDate()+1),e.setHours(10,0,0,0);const t=e.toISOString().split("T")[0],n=document.querySelector('input[name="schedule.date"]'),o=document.querySelector('input[name="schedule.time"]');n&&(n.value=t),o&&(o.value="10:00"),w(e)}()});const i=document.querySelector(".btn-clear-auto-submit");i&&i.addEventListener("click",()=>{!function(){const e=document.querySelector('input[name="schedule.date"]'),t=document.querySelector('input[name="schedule.time"]');e&&(e.value=""),t&&(t.value=""),v()}()});const c=document.querySelector("#notification-preview-clickable");c&&c.addEventListener("click",()=>{const e=document.querySelector('input[name="notification.clickAction"]');e&&e.value&&window.open(e.value,"_blank","noopener,noreferrer")}),g(),l&&setTimeout(()=>{m()},100)}(),b(),r.auth().listen({account:!1},async e=>{console.log("Auth state for notification creator:",e),b(),await y(),p()}))}()}catch(e){r.sentry().captureException(new Error("Failed to initialize notification creator",{cause:e}))}return t()});let l=null,u={totalUsers:0,filteredUsers:0},d=null,f=!1;function m(e){const t=l.getData();g(t),function(e){const t=e.notification||{},n=document.querySelector("#title-char-count");if(n){const e=(t.title||"").length;n.textContent=`${e} / 60`,n.className=e>60?"text-danger":"text-muted"}const o=document.querySelector("#body-char-count");if(o){const e=(t.body||"").length;o.textContent=`${e} / 200`,o.className=e>200?"text-danger":"text-muted"}}(t),function(e){if(e.schedule?.date&&e.schedule?.time){const t=new Date(`${e.schedule.date}T${e.schedule.time}`);t>new Date?w(t):v()}else v()}(t)}async function h(e){const t=e.detail?.data||l.getData();try{const e=function(e){console.log("[Debug] transformDataForAPI called"),console.log("[Debug] formData received:",e),console.log("[Debug] formData.notification:",e.notification);const t=new Date,n=e.notification||{};console.log("[Debug] notification object:",n),console.log("[Debug] notification.clickAction:",n.clickAction),console.log("[Debug] typeof notification:",typeof n),console.log("[Debug] Object.keys(notification):",Object.keys(n));const o=t.getTime(),i=new URL("https://promo-server.itwcreativeworks.com/redirect/notification");i.searchParams.set("id",o),i.searchParams.set("type","notification");const c=n.clickAction||"";return console.log("[Debug] clickActionValue to be set in URL:",c),i.searchParams.set("url",c),{id:o,notification:{icon:n.icon||"",title:n.title||"",body:n.body||"",clickAction:i.toString()},created:t.toISOString(),channels:e.channels||{},audience:e.audience||{},schedule:e.schedule||{}}}(t);e.reach={available:{total:u.totalUsers},filtered:{total:u.filteredUsers}},await async function(e){const t=S();return a(t,{method:"POST",timeout:6e4,response:"json",tries:1,log:!0,body:{command:"admin:send-notification",payload:e}})}(e),!function(e){"undefined"!=typeof gtag&&gtag("event","notification_sent",{notification_type:"admin",user_count:u.filteredUsers,channels:Object.keys(e.channels||{}).filter(t=>e.channels[t]?.enabled).join(",")}),"undefined"!=typeof fbq&&fbq("trackCustom","AdminNotificationSent",{users:u.filteredUsers,channels:Object.keys(e.channels||{}).filter(t=>e.channels[t]?.enabled)}),"undefined"!=typeof ttq&&ttq.track("SubmitForm",{content_name:"Admin Notification",content_type:"notification",value:u.filteredUsers})}(e),l.showSuccess(`Notification sent successfully to ${u.filteredUsers.toLocaleString()} users!`)}catch(e){console.error("Notification send error:",e),r.sentry().captureException(new Error("Failed to send notification",{cause:e})),l.showError(e.message||"Failed to send notification")}}async function y(){try{const e=await a(S(),{method:"POST",timeout:6e4,response:"json",tries:2,log:!0,body:{command:"admin:firestore-read",payload:{path:"meta/stats"}}}),t=e?.notifications?.total||0;u.totalUsers=t,u.filteredUsers=t}catch(e){console.error("Failed to fetch user stats:",e),r.sentry().captureException(new Error("Failed to fetch user stats",{cause:e})),u.totalUsers=0,u.filteredUsers=0}}function p(){document.querySelectorAll(".notification-user-count").forEach(e=>{e.innerHTML=`${u.filteredUsers.toLocaleString()} / ${u.totalUsers.toLocaleString()}`})}function b(){document.querySelectorAll(".notification-user-count").forEach(e=>{e.innerHTML='<span class="spinner-border spinner-border-sm me-1" role="status"></span>Loading...'})}function g(e=null){e||(e=l?.getData()||{});const t=e.notification||{},n=document.querySelector("#preview-icon"),o=document.querySelector("#preview-title"),i=document.querySelector("#preview-body"),c=document.querySelector("#preview-time");n&&t.icon&&(n.src=t.icon,n.onerror=()=>{n.src="https://via.placeholder.com/50"}),o&&(o.textContent=t.title||"Notification Title"),i&&(i.textContent=t.body||"This is what your notification body will look like..."),c&&(c.textContent="Now")}function w(e){v();const t=document.querySelector("#auto-submit-countdown");t&&(t.classList.remove("d-none"),d=setInterval(()=>{const n=new Date,o=e-n;if(o<=0)return v(),void y().then(()=>p()).finally(()=>l.submit());const i=Math.floor(o/36e5),c=Math.floor(o%36e5/6e4),a=Math.floor(o%6e4/1e3);t.innerHTML=`<i class="bi bi-clock"></i> Auto-submit in: ${i}h ${c}m ${a}s`},1e3))}function v(){d&&(clearInterval(d),d=null);const e=document.querySelector("#auto-submit-countdown");e&&(e.classList.add("d-none"),e.innerHTML="")}function S(){return`${r.getFunctionsUrl("prod")}/bm_api`}}}]);